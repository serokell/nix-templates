on:
  schedule:
    # runs every Monday at 10:00 am UTC
    - cron: '0 10 * * 1'

jobs:
  check-outdated:
    runs-on: [self-hosted, nix]
    outputs:
      msg: ${{ steps.outdated.outputs.outdated }}
    steps:
      - uses: actions/checkout@v4

      - name: check outdated packages
        id: outdated
        run: |
          function output {
            echo "outdated<<EOF" >> $GITHUB_OUTPUT
            echo "Repository https://github.com/${{ github.repository }} has outdated haskell dependencies" >> $GITHUB_OUTPUT
            echo "$msg" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          }

          nix develop .#ci -c cabal update
          trap 'output' ERR
          msg=$(nix develop .#ci -c cabal outdated --exit-code)

  report-outdated:
    runs-on: [self-hosted, nix]
    if: failure()
    needs: check-outdated
    steps:
      - uses: actions/checkout@v4

      - name: Report outdated haskell dependencies
        env:
          MSG: ${{needs.check-outdated.outputs.msg}}
        run: |
          # you can change 'libraries' to the channel dedicated to the library, if there is one
          # in order for a bot to be able to post messages, it must be added to the appropriate channel
          nix develop .#ci -c curl -XPOST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer ${{ env.SLACK_TOKEN }}" \
            -d "channel=libraries" \
            -d "text=$MSG"
